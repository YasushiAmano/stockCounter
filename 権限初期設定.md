# 権限初期設定

Octane/Jetstreamを使用している場合、Spatieパッケージのインストールと基本設定、ロールとパーミッションの設定（シーダー）、Laravel 11 + Octane用のミドルウェア設定が必要になります。

Laravel 11 + Octaneでは、middleware.phpを作成して、app.phpに設定しないとweb.phpのルーティングでエラーになります。

## パッケージインストール

```sh
composer require spatie/laravel-permission
```

## マイグレーション

```sh
php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider"
php artisan migrate
```

## ユーザーモデルの修正

User.php

```php
use Spatie\Permission\Traits\HasRoles;

class User extends Authenticatable
{
    use HasRoles;
    // ... 既存のコード ...
}
```

## seeder

サンプルデーターの登録

src/database/seeders/RoleAndPermissionSeeder.php

```php
<?php

namespace Database\Seeders;

use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;
use Spatie\Permission\Models\Role;
use Spatie\Permission\Models\Permission;

class RoleAndPermissionSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        // パーミッションの作成
        $permissions = [
            'view_admin_page',
            'view_manager_page',
            'view_user_page'
        ];

        foreach ($permissions as $permission) {
            Permission::create(['name' => $permission]);
        }

        // admin ロールの作成と権限付与
        $adminRole = Role::create(['name' => 'admin']);
        $adminRole->givePermissionTo($permissions);

        // manager ロールの作成と権限付与
        $managerRole = Role::create(['name' => 'manager']);
        $managerRole->givePermissionTo([
            'view_manager_page',
            'view_user_page'
        ]);

        // user ロールの作成と権限付与
        $userRole = Role::create(['name' => 'user']);
        $userRole->givePermissionTo([
            'view_user_page'
        ]);
    }
}
```

src/database/seeders/UserSeeder.php

```php
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use App\Models\User;

class UserSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        // 管理者ユーザーの作成
        $admin = User::create([
            'name' => 'Admin User',
            'email' => 'admin@admin.com',
            'password' => bcrypt('password')
        ]);
        $admin->assignRole('admin');

        // マネージャーユーザーの作成
        $manager = User::create([
            'name' => 'Manager User',
            'email' => 'manager@manager.com',
            'password' => bcrypt('password')
        ]);
        $manager->assignRole('manager');

        // 一般ユーザーの作成
        $user = User::create([
            'name' => 'Normal User',
            'email' => 'user@user.com',
            'password' => bcrypt('password')
        ]);
        $user->assignRole('user');
    }
}
```

### 実行

```sh
php artisan db:seed --class=RoleAndPermissionSeeder
php artisan db:seed --class=UserSeeder
```

## src/bootstrap/app.php

Spatie\Permission\PermissionServiceProvider::classを追加
middleware.phpを作成し、middleware.phpとエイリアスを登録

```php
return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        api: __DIR__.'/../routes/api.php',
        commands: __DIR__.'/../routes/console.php',
        health: '/up',
    )
    ->withProviders([
        // 既存のプロバイダー
        Spatie\Permission\PermissionServiceProvider::class,
    ])
    ->withMiddleware(function (Middleware $middleware) {
        // middleware.phpの設定を読み込む
        $config = require __DIR__ . '/middleware.php';

        // エイリアスを登録
        $middleware->alias($config['aliases']);
    })
    ->withExceptions(function (Exceptions $exceptions) {
        //
    })
    ->create();
```

### src/bootstrap/middleware.php

```php
<?php

use Illuminate\Http\Middleware\HandleCors;
use Illuminate\Http\Middleware\TrustProxies;
use Illuminate\Foundation\Http\Middleware\ValidatePostSize;
use Spatie\Permission\Middleware\PermissionMiddleware;
use Spatie\Permission\Middleware\RoleMiddleware;
use Spatie\Permission\Middleware\RoleOrPermissionMiddleware;

return [
    'web' => [
        // 既存のwebミドルウェア
    ],

    'api' => [
        // 既存のapiミドルウェア
    ],

    'aliases' => [
        // 既存のエイリアス
        'permission' => PermissionMiddleware::class,
        'role' => RoleMiddleware::class,
        'role_or_permission' => RoleOrPermissionMiddleware::class,
    ],
];
```

## web.phpの修正

```php
<?php

use Illuminate\Support\Facades\Route;

Route::get('/', function () {
    return view('welcome');
});

Route::middleware([
    'auth:sanctum',
    config('jetstream.auth_session'),
    'verified',
])->group(function () {
    Route::get('/dashboard', function () {
        return view('dashboard');
    })->name('dashboard');

    // マネージャー用ルート
    Route::group([
        'prefix' => 'manager',
        'middleware' => 'permission:view_manager_page'
    ], function () {
        Route::get('/index', function () {
            return 'マネージャーページにアクセスできました！';
        });
    });

    // 管理者用ルート
    Route::group([
        'prefix' => 'admin',
        'middleware' => 'permission:view_admin_page'
    ], function () {
        Route::get('/index', function () {
            return '管理者ページにアクセスできました！';
        });
    });

    // ユーザー用ルート
    Route::group([
        'prefix' => 'user',
        'middleware' => 'permission:view_user_page'
    ], function () {
        Route::get('/index', function () {
            return 'ユーザーページにアクセスできました！';
        });
    });
});
```
